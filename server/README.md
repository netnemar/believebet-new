# Pokets Payout Server

Сервер автоматических выплат для платформы Pokets. Этот сервер обрабатывает запросы на выплаты выигрышей пользователям.

## Требования

- Node.js 16+ и npm
- Solana CLI (опционально, для дополнительных инструментов)
- Кошелек Solana с SOL для выплат

## Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/pokets/pokets.git
cd pokets/server
```

2. Установите зависимости:
```bash
npm install
```

3. Создайте файл конфигурации `.env` на основе примера:
```bash
cp .env.example .env
```

4. Отредактируйте файл `.env` и укажите необходимые параметры:
   - `HOUSE_WALLET_SECRET_KEY`: Приватный ключ кошелька для выплат (base58)
   - `RPC_ENDPOINT`: RPC эндпоинт Solana (рекомендуется платный для продакшна)
   - `JWT_SECRET`: Секретный ключ для JWT токенов (для авторизации API)

## Настройка кошелька

Есть два способа настройки хаус-кошелька:

### 1. Через файл .env (рекомендуется для продакшена)

Укажите приватный ключ кошелька в переменной `HOUSE_WALLET_SECRET_KEY` в файле `.env`.

### 2. Через файл ключа (автоматически)

Если переменная `HOUSE_WALLET_SECRET_KEY` не указана, сервер попытается загрузить ключ из файла `.house-wallet.json` в директории сервера. Если файл не существует, сервер создаст новый тестовый кошелек.

## Запуск

### Для разработки:

```bash
npm run dev
```

### Для продакшена:

```bash
npm start
```

Сервер запустится на порту, указанном в `.env` (по умолчанию 3001).

## API Endpoints

### Проверка баланса хаус-кошелька

```
GET /api/balance
```

Заголовки:
- `Authorization: Bearer YOUR_TOKEN`

Ответ:
```json
{
  "success": true,
  "balance": 10.5
}
```

### Отправка выплаты

```
POST /api/payouts
```

Заголовки:
- `Content-Type: application/json`
- `Authorization: Bearer YOUR_TOKEN`

Тело запроса:
```json
{
  "amount": 1.5,
  "destination": "WALLET_ADDRESS",
  "gameId": "GAME_ID"
}
```

Ответ:
```json
{
  "success": true,
  "signature": "TRANSACTION_SIGNATURE",
  "amount": 1.5,
  "destination": "WALLET_ADDRESS",
  "timestamp": 1625123456789
}
```

## Безопасность

⚠️ **ВАЖНО** ⚠️

- Никогда не коммитьте файл `.env` или `.house-wallet.json` в репозиторий
- Используйте HTTPS для всех API запросов
- В продакшене храните приватный ключ в защищенном хранилище секретов (например, AWS Secrets Manager)
- Настройте файрвол для ограничения доступа к серверу

## Интеграция с клиентом

В клиентском коде используйте значение переменной `PAYOUT_API_URL` в файле `pokets/lib/AutomaticPayoutService.ts` для указания адреса сервера выплат.

## Логирование

Сервер записывает логи в консоль. Для продакшена рекомендуется настроить внешнее логирование (например, через Winston).

## Мониторинг

Для мониторинга состояния кошелька и отслеживания выплат рекомендуется интегрировать с системой мониторинга (например, Prometheus + Grafana). 